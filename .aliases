# Shared exports (used by both bash and zsh)
export EDITOR='nvim'
export VISUAL='nvim'
export GIT_EDITOR='nvim'

# Colors
export LSCOLORS=exfxdxDxcxhxhxhxhxExEx
export GREP_COLOR='1;38;5;136'

pushd()
{
  if [ $# -eq 0 ]; then
    DIR="${HOME}"
  else
    DIR="$1"
  fi

  builtin pushd "${DIR}" > /dev/null
}

pushd_builtin()
{
  builtin pushd > /dev/null
}

popd()
{
  builtin popd > /dev/null
}

alias cd='pushd'
alias up='popd'
alias flip='pushd_builtin'

alias la="ll -a"
alias rm="rm -i"
alias c='clear'
alias h='history'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'

# Git aliases
alias gpu='git push -u origin $(git branch --show-current)'
alias gfp='git fetch --prune'
alias gfm='git fetch && git merge origin/main'
alias gclean='git clean -fd'
alias gundo='git reset --soft HEAD~1'
alias glgraph='git log --oneline --graph --decorate --all'
alias groot='cd $(git rev-parse --show-toplevel)'

# Git worktree helpers
gwt() {
  local git_root=$(git rev-parse --show-toplevel)
  local wt_path="$(dirname "$git_root")/$1"
  git pull && git worktree add -b "benh/$1" "$wt_path" && tmux new-window -n "$1" -c "$wt_path"
}

grmwt() {
  git worktree list | fzf | awk '{print $1}' | xargs git worktree remove --force
}

alias grmlck='rm -f "$(git rev-parse --git-path index.lock)"'

alias web_finder="python3 -m http.server --bind $HOSTNAME"
alias yank='yank | sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,3})*)?[mGKHf]//g; s/\x0f//g" | ${DOTFILES:-$HOME/dotfiles}/osc52.sh'
alias vim='nvim'
alias vo='vim -c "FzfLua files"'
alias vimdiff='nvim -d'

# make less always work with colored input
alias less='less -R'

# make watch always work with colored input
alias watch='watch --color'

if [[ $OSTYPE == linux* ]]; then
    alias grep="grep --color=auto"
    alias ls="ls --color"
    alias ll="ls -lhtU --time-style long-iso"
else
    # macOS
    alias grep="grep --color=auto"
    export CLICOLOR=1
    alias ls="ls"
    alias ll="ls -lht"
fi

# Options to fzf command
export FZF_COMPLETION_OPTS='--border --info=inline'

# Use fd (https://github.com/sharkdp/fd) for listing path candidates.
# - The first argument to the function ($1) is the base path to start traversal
# - See the source code (completion.{bash,zsh}) for the details.
_fzf_compgen_path() {
  fd --follow --exclude ".git" --exclude "venv*" . "$1"
}

# Use fd to generate the list for directory completion
_fzf_compgen_dir() {
  fd --type d --follow --exclude ".git" --exclude "venv*" . "$1"
}

# Advanced customization of fzf options via _fzf_comprun function
# - The first argument to the function is the name of the command.
# - You should make sure to pass the rest of the arguments to fzf.
_fzf_comprun() {
  local command=$1
  shift

  case "$command" in
    cd)           fzf --preview 'tree -C {} | head -200'   "$@" ;;
    export|unset) fzf --preview "eval 'echo \$'{}"         "$@" ;;
    ssh)          fzf --preview 'dig {}'                   "$@" ;;
    *)            fzf --preview 'bat -n --color=always {}' "$@" ;;
  esac
}

alias clauded="claude --dangerously-skip-permissions"

# Pager
export PAGER=less

# Python
export PIP_REQUIRE_VIRTUALENV=true
export PYTHONBREAKPOINT="pdbp.set_trace"

# Utility function to set up a Python virtual environment
setup_venv() {
    UV_PYTHON=$(which python) uv venv
    source .venv/bin/activate
    python -m ensurepip --upgrade
    python -m pip install --upgrade pip uv
    rehash
    uv pip install ipython pdbp
}
